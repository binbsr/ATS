@inject ApplicationDbContext Db

<MudDialog>
    <DialogContent>
        <MudBreadcrumbs Items="_siteItems"></MudBreadcrumbs>

        <MudTextField Label="Title" @bind-Value="SectionItem.Title" Variant="Variant.Outlined" />

        <MudTextField @bind-Value="@SectionItem.Content"
                      Placeholder="Add Item Content HTML..."
                      Lines="10"
                      Variant="Variant.Outlined"
                      Label="Section Item HTML" AutoGrow />
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled"
                   OnClick="Cancel"
                   StartIcon="@Icons.Material.Sharp.Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Warning"
                   Disabled="SectionItem.Content == string.Empty"
                   StartIcon="@Icons.Material.Sharp.Save"
                   OnClick="Submit">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState> AuthTask { get; set; } = null!;

    [Parameter]
    public int SectionId { get; set; }

    [Parameter]
    public SectionItem? SectionItem { get; set; }

    private bool IsAdd => SectionItem is null;

    private List<BreadcrumbItem> _siteItems =
    [
        new("Site", href: null, icon: Icons.Material.Filled.WebAsset),
        new("Section", href: null, icon: Icons.Material.Filled.TableRows),
        new("Widget", href: null, icon: Icons.Material.Filled.Widgets)
    ];

    private async Task Submit()
    {
        var rowsAffected = 0;
        var state = await AuthTask;
        var userName = state.User.Identity?.Name;

        if (IsAdd)
        {
            if (SectionItem is null)
                return;

            if (string.IsNullOrWhiteSpace(SectionItem.Content))
                return;

            SectionItem.AddCreatedStamps(userName);
            SectionItem.AddLastUpdatedStamps(userName);

            Db.SectionItems.Add(SectionItem);
        }
        else
        {
            var existingModel = await Db.SectionItems.FindAsync(SectionItem.Id);
            if (existingModel is null)
                return;

            existingModel.Title = SectionItem.Title;
            existingModel.Content = SectionItem.Content;
            existingModel?.AddLastUpdatedStamps(userName);

            Db.SectionItems.Update(existingModel);
        }

        rowsAffected = await Db.SaveChangesAsync();

        MudDialog?.Close(DialogResult.Ok(SectionItem));
    }

    private void Cancel() => MudDialog?.Cancel();
}
