@page "/sites/{Id}/manage"
@inject ApplicationDbContext Db
@inject IDialogService DialogService

<PageTitle>@(site?.Name ?? "Site Details")</PageTitle>

@if (site is null)
{
    <Loading />
}
else
{
    <MudPaper Outlined="true" Class="d-flex align-center justify-center flex-grow-1 gap-4 p-3">
        <MudText Typo="Typo.h5" Align="Align.Center">@site.Name</MudText>
        <MudLink Typo="Typo.h5" Href="@site.Domain" Color="Color.Info" Target="_blank">@site.Domain <MudIcon Icon="@Icons.Material.Sharp.OpenInNew" /></MudLink>
        <MudIconButton Color="Color.Warning" Href=@($"/admin/website/edit/{site.Id}") Icon="@Icons.Material.Sharp.Edit" />
    </MudPaper>
    @if (site.Sections is null or [])
    {
        <ApplicationAlert Text=@($"No web site sections found for {site.Name}.") />
    }
    else
    {
        <MudExpansionPanels MultiExpansion="true">
            @foreach (var section in site.Sections)
            {
                <MudExpansionPanel Text="@(section.Title)" Expanded="@true">
                    @foreach (var widget in section.Widgets ?? [])
                    {
                        <MudCard>
                            <MudCardContent>
                                @((MarkupString)widget.HtmlContent)
                            </MudCardContent>
                            <MudCardActions>
                                <MudIconButton Color="Color.Warning"
                                               Icon="@Icons.Material.Sharp.Edit"
                                               OnClick="@((e) => AddSiteItemAsync(section.Id, widget))" />
                            </MudCardActions>
                        </MudCard>
                    }
                    <MudCard>
                        <MudCardContent>
                            <MudIconButton Icon="@Icons.Material.Filled.Add"
                                           Variant="Variant.Filled"
                                           OnClick="@((e) => AddSiteItemAsync(section.Id, null!))"
                                           Size="Size.Large" />
                        </MudCardContent>
                    </MudCard>
                </MudExpansionPanel>
            }
        </MudExpansionPanels>
    }
}

@code {

    [Parameter]
    public string Id { get; set; }

    public Site site;

    protected override async Task OnInitializedAsync()
    {
        site = await Db.Sites.Where(x => x.Id == Id)
                            .Include(y => y.Sections)
                            .ThenInclude(z => z.Widgets)
                            .FirstOrDefaultAsync() ?? new();
    }

    private async Task AddSiteItemAsync(int sectionId, Widget widget)
    {
        var parameters = new DialogParameters<EditWidgetDialog> { { x => x.SectionId, sectionId }, { x => x.Model, widget } };
        var options = new DialogOptions { CloseButton = true, MaxWidth=MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<EditWidgetDialog>((widget == null ? "Edit " : "Add ") + "Widget", parameters, options);
        var result = await dialog.Result;
    }
}
