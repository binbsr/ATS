@page "/dashboard/admin"

@attribute [Authorize(Roles = Role.Admins)]
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<PageTitle>Admin Dashboard</PageTitle>

@if (loadingData)
{
    <MudText Align="MudBlazor.Align.Center">
        <MudProgressCircular Indeterminate Color="MudBlazor.Color.Tertiary" Size="MudBlazor.Size.Medium" />
    </MudText>
}
else
{
    <MudGrid>
        <MudItem md="4">
            <MudPaper Elevation="5" Class="pa-5">
                <MudChart ChartType="ChartType.Donut" Width="350px" Height="350px" LegendPosition="Position.Right"
                          InputData="@studentByTypesCount"
                          InputLabels="@studentByTypesKeys">
                    <CustomGraphics>
                        <text class="donut-inner-text" x="50%" y="35%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="25">Total</text>
                        <text class="donut-inner-text" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="50">@studentByTypesCount.Sum().ToString()</text>
                    </CustomGraphics>
                </MudChart>
            </MudPaper>
        </MudItem>

        <MudItem md="4">
            <MudPaper Elevation="5" Class="pa-5">
                <MudChart ChartType="ChartType.Donut" Width="350px" Height="350px" LegendPosition="Position.Right"
                          InputData="@studentByStatusCount"
                          InputLabels="@studentByStatusKeys">
                    <CustomGraphics>
                        <text class="donut-inner-text" x="50%" y="35%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="25">Total</text>
                        <text class="donut-inner-text" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="50">@studentByStatusCount.Sum().ToString()</text>
                    </CustomGraphics>
                </MudChart>                
            </MudPaper>
        </MudItem>

        <MudItem md="4">
            <MudPaper Elevation="5" Class="pa-5">
                <MudChart ChartType="ChartType.Donut" Width="350px" Height="350px" LegendPosition="Position.Right"
                          InputData="@studentByBatchCount"
                          InputLabels="@studentByBatchKeys">
                    <CustomGraphics>
                        <text class="donut-inner-text" x="50%" y="35%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="25">Total</text>
                        <text class="donut-inner-text" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="50">@studentByBatchCount.Sum().ToString()</text>
                    </CustomGraphics>
                </MudChart>               
            </MudPaper>
        </MudItem>

        <MudItem md="4">
            <MudPaper Elevation="5" Class="pa-5">
                <MudStack Row AlignItems="AlignItems.Baseline">
                    <MudText Typo="Typo.body1" Align="MudBlazor.Align.Center" Class="mb-5">Show trainee applications since</MudText>
                    <MudSelect T="int"
                               Value="days"
                               ValueChanged="DaysSelectionChanged"
                               AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="1">yesterday</MudSelectItem>
                        <MudSelectItem Value="3">Last 3 days</MudSelectItem>
                        <MudSelectItem Value="7">Last week</MudSelectItem>
                        <MudSelectItem Value="30">Last month</MudSelectItem>
                        <MudSelectItem Value="90">Last 3 months</MudSelectItem>
                        <MudSelectItem Value="365">Last year</MudSelectItem>
                    </MudSelect>
                </MudStack>
                <MudPaper Class="p-4">
                    <MudNavLink Href="@($"/applicants?highlight={string.Join(",", lastnDaysIds)}")" Style="font-size:2rem">
                        <MudIcon Color="MudBlazor.Color.Tertiary" Size="MudBlazor.Size.Large" Icon="@Icons.Material.Sharp.People" Class="mr-2" />
                        <MudText Typo="Typo.h5" Inline>@("person".ToQuantity(lastnDaysIds.Count())) applied</MudText>
                    </MudNavLink>
                </MudPaper>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudTabs Class="mt-8 border-2" Outlined="true" Rounded="true" ApplyEffectsToContainer="true">
        <MudTabPanel Text="Trainee Profiles" Style="font-size:1rem;padding:1rem;">
            <MudTable Items="@traineeProfiles" Hover="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Batch</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>ATS Profile</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Batch">@context.BatchName</MudTd>
                    <MudTd DataLabel="Status">@context.Status</MudTd>
                    <MudTd DataLabel="Profile">
                        <MudLink Href="@($"/profile/trainee/{context.UserId}")" Target="_blank">
                            <MudIcon Icon="@Icons.Material.Sharp.OpenInNew" />
                            @context.UserId
                        </MudLink>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 20, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudTabPanel>
        <MudTabPanel Text="Professional Profiles" Style="font-size:1rem;padding:1rem;">
            <MudTable Items="@employeeProfiles" Hover="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Training Quotation</MudTh>
                    <MudTh>Organization</MudTh>
                    <MudTh>Profile</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Training">@context.Training</MudTd>
                    <MudTd DataLabel="Organization">@context.Organization</MudTd>
                    <MudTd DataLabel="Profile">
                        <MudLink Href="@($"/profile/professional/{context.Id}")" Target="_blank">
                            <MudIcon Icon="@Icons.Material.Sharp.OpenInNew" />
                            @context.Id
                        </MudLink>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 20, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudTabPanel>
    </MudTabs>
}

@code {

    bool loadingData = false;

    private int days = 7;
    private IEnumerable<string> lastnDaysIds = [];
    private record StudentAggregate(string Label, double Count);

    private List<Student> allStudents = [];
    private StudentLightViewModel[]? traineeProfiles;
    private ProfessionalViewModel[]? employeeProfiles;
    string[] studentByTypesKeys = [];
    double[] studentByTypesCount = [];
    string[] studentByStatusKeys = [];
    double[] studentByStatusCount = [];
    string[] studentByBatchKeys = [];
    double[] studentByBatchCount = [];

    protected override async Task OnInitializedAsync()
    {
        loadingData = true;

        using var Db = DbFactory.CreateDbContext();
        allStudents = await Db.Students
            .Include(x => x.TechProgram)
            .Include(y => y.College)
            .Include(z => z.Batch)
            .Include(a => a.Training)
            .ThenInclude(b => b.Organization)
            .ToListAsync();

        if (allStudents is null || !allStudents.Any())
        {
            loadingData = false;
            return;
        }

        // Group by application type
        var studentsByTypes = allStudents
           .GroupBy(x => x.ApplicantType)
           .Select(y => new StudentAggregate(y.Key.ToString(), y.Count()));

        studentByTypesKeys = studentsByTypes.Select(x => x.Label).ToArray();
        studentByTypesCount = studentsByTypes.Select(x => x.Count).ToArray();

        // Group students by stage
        var studentsByStatus = allStudents
            .GroupBy(x => x.Status)
            .Select(y => new StudentAggregate(y.Key.ToString(), y.Count()));

        studentByStatusKeys = studentsByStatus.Select(x => x.Label).ToArray();
        studentByStatusCount = studentsByStatus.Select(x => x.Count).ToArray();

        // Group by batch
        var studentsByBatch = allStudents
           .GroupBy(x => x.Batch?.Name ?? "No Batch")
           .Select(y => new StudentAggregate(y.Key, y.Count()));

        studentByBatchKeys = studentsByBatch.Select(x => x.Label).ToArray();
        studentByBatchCount = studentsByBatch.Select(x => x.Count).ToArray();

        lastnDaysIds = GetLastNDaysStudnets(days);

        // Trainee profile list
        traineeProfiles = allStudents
            .Where(x => x.Status != Status.Applied &&
                (x.ApplicantType == ApplicantType.StudentInternship ||
                x.ApplicantType == ApplicantType.SoftwareEngineeringAspirant))
            .Select(x => new StudentLightViewModel
                    (
                        x.Name,
                        x.Id,
                        x.ProfileImagePath ?? "/person.png",
                        x.Status,
                        "",
                        x.Batch?.Name ?? "None"
                    )
                ).ToArray();

        // professionals profile list
        employeeProfiles = allStudents
            .Where(x => x.Status != Status.Applied &&
                x.ApplicantType == ApplicantType.Professional)
            .Select(x => new ProfessionalViewModel
                (
                    x.Id,
                    x.Name,
                    x.ProfileImagePath ?? "/person.png",
                    x.Status,
                    x.Training?.Title ?? "None",
                    x.Training?.Organization?.Name ?? "None"
                )
            ).ToArray();

        loadingData = false;
    }

    private void DaysSelectionChanged(int daysSelected)
    {
        days = daysSelected;
        lastnDaysIds = GetLastNDaysStudnets(days);
    }

    private IEnumerable<string> GetLastNDaysStudnets(int daysCount) =>
        allStudents.Where(x => x.FormSubmitted > DateTime.Now.AddDays(-daysCount)).Select(y => y.Id);
}
