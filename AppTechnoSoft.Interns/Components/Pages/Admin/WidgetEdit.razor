@page "/add-widget"
@page "/edit-widget/{Id:int}"

@inject ApplicationDbContext Db
@inject ISnackbar SnackBar

<PageTitle>@pageTitle</PageTitle>

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <MudSelect T="string" Label="Widget Type" @bind-Value="model.Title" Variant="Variant.Outlined">
        @foreach (var filter in widgetFilters)
        {
            <MudSelectItem Value="@filter">@filter</MudSelectItem>
        }
    </MudSelect>

    <MudTextField Label="Description" Class="mt-3" @bind-Value="model.Description" Variant="Variant.Outlined" />

    <MudSelect T="Tag"
               Label="Tags"
               Dense="true"
               Variant="Variant.Outlined"
               HelperText="Check all tags that apply to this widget"
               MultiSelection="true"
               @bind-SelectedValues="@tagsSelected"
               Class="mb-4"
               MultiSelectionTextFunc="@(new Func<List<string>, string>(GetMultiSelectionText))">
        @foreach (var tag in tags)
        {
            <MudSelectItem Value="@tag">@tag.Name</MudSelectItem>
        }
    </MudSelect>

    <RichTextEditor @bind-Content="@model.HtmlContent"
                    Placeholder="Add Widget Contents..."                    
                    ToolbarOptions="ToolbarOptions.FullToolbarOptions" />

    <MudStack Row Class="mt-2">
        <MudButton ButtonType="ButtonType.Submit"
                   Variant="Variant.Filled"
                   Color="Color.Tertiary"
                   StartIcon="@Icons.Material.Filled.Save">
            Save Widget
        </MudButton>
        <MudButtonGroup Color="Color.Tertiary" Variant="Variant.Outlined">
            <MudButton StartIcon="@Icons.Material.Sharp.ArrowBack">Back to</MudButton>
            <MudMenu Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
                <MudMenuItem Href="/course/modules">Modules</MudMenuItem>
                <MudMenuItem Href="/">Home Page</MudMenuItem>
                <MudMenuItem Href="/prospectus">Prospectus</MudMenuItem>
            </MudMenu>
        </MudButtonGroup>
    </MudStack>
</EditForm>
@code {

    [Parameter]
    public int? Id { get; set; }

    [SupplyParameterFromQuery(Name = "Site")]
    public string? Site { get; set; }

    [SupplyParameterFromQuery(Name = "Section")]
    public int? Section { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState> AuthTask { get; set; } = null!;
    
    Widget model = new Widget();
    List<Tag> tags = new();
    IEnumerable<Tag> tagsSelected = [];
    string[] widgetFilters =
    [
        WidgetType.CourseModule,
        WidgetType.SiteItem
    ];

    string pageTitle = string.Empty;
    bool IsAdd => Id is null or 0;
    bool IsSiteSection => Site != null && Section != null;

    protected override async Task OnInitializedAsync()
    {
        tags = await Db.Tags.ToListAsync();

        if (IsAdd)
        {
            pageTitle = "Add Widget";
            model.Title = IsSiteSection ? WidgetType.SiteItem : WidgetType.CourseModule;
        }
        else
        {
            pageTitle = "Edit Widget";
            model = await Db.Widgets.Include(x => x.Tags).FirstAsync(x => x.Id == Id);
            tagsSelected = model.Tags ?? [];
        }
    }

    private async Task OnValidSubmit(EditContext context)
    {
        if (model.HtmlContent is null or "")
        {
            SnackBar.Add("No content provided for the widget", Severity.Warning);
            return;
        }

        var state = await AuthTask;
        var userName = state.User.Identity?.Name;

        model.Tags = tagsSelected.ToList();

        if (IsAdd)
        {
            model.AddCreatedStamps(userName);
            Db.Widgets.Add(model);
            await Db.SaveChangesAsync();

            if (IsSiteSection)
            {
                Db.SectionWidgets.Add(
                    new SectionWidget
                    {
                        SectionId = Section!.Value,
                        WidgetId = model.Id,
                        Order = 0,
                        Enabled = true
                    });
            }
        }
        else
        {
            model.Id = Id!.Value;
            model.AddLastUpdatedStamps(userName);
            Db.Widgets.Update(model);
        }

        var rowsAffected = await Db.SaveChangesAsync();

        if (rowsAffected > 0)
        {
            SnackBar.Add("Widget saved successfully", Severity.Success);
        }
        else
        {
            SnackBar.Add("Widget save failed", Severity.Error);
        }
    }

    private string GetMultiSelectionText(List<string> selectedValues)
    {
        return $"{selectedValues.Count} tag{(selectedValues.Count > 1 ? "s have" : " has")} been selected";
    }
}
