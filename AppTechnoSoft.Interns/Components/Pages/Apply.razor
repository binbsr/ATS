@page "/apply"

<PageTitle>Apply For Internship</PageTitle>

@inject ApplicationDbContext Db
@inject ISnackbar SnackBar

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <MudGrid Class="pa-4">
        <MudItem md="6" xs="12">
            <MudTextField @bind-Value="model.Name"
                          For="@(() => model.Name)"
                          Immediate="true"
                          Label="Full Name" />
        </MudItem>
        <MudItem md="6" xs="12">
            <MudTextField @bind-Value="model.Email"
                          For="@(() => model.Email)"
                          Immediate="true"
                          Label="Email" />
        </MudItem>
        <MudItem md="6" xs="12">
            <MudTextField @bind-Value="model.Phone"
                          For="@(() => model.Phone)"
                          Immediate="true"
                          Label="Phone" />
        </MudItem>
        <MudItem md="6" xs="12">
            <MudAutocomplete T="College" Label="Select College" @bind-Value="model.College"
                             SearchFunc="@SearchColleges" ToStringFunc="@(e=> e==null ? null : $"{e.Name} ({e.Location})")" ShowProgressIndicator="true" />
        </MudItem>
        <MudItem md="6" xs="12">
            <MudAutocomplete T="TechProgram" Label="Select Program" @bind-Value="model.TechProgram"
                             SearchFunc="@SearchPrograms" ToStringFunc="@(e=> e==null ? null : $"{e.Name} ({e.Affliation})")" ShowProgressIndicator="true" />
        </MudItem>

        <MudItem md="6" xs="12">
            <MudFileUpload T="IBrowserFile" Accept=".png, .jpg" @bind-Files="@model.ProfileImage">
                <ButtonTemplate Context="btnContext">
                    <MudButton HtmlTag="label"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Image"
                               for="@btnContext.Id">
                        Upload Profile
                    </MudButton>
                </ButtonTemplate>
            </MudFileUpload>
        </MudItem>

        <MudItem md="12">
            <MudPaper Class="pa-5" Elevation="5">
                <MudGrid>
                    <MudItem md="12">
                        <MudText Typo="Typo.h6">Your experience and knowledge</MudText>
                        <MudText Typo="Typo.subtitle1">Please be as sincere as you can, it's important to enroll you to appropriate batch</MudText>
                    </MudItem>
                    <MudItem md="6" xs="12">
                        <MudText Typo="Typo.button">Web Development</MudText>
                        <MudRadioGroup @bind-Value="@model.WebExperience">
                            <MudStack Spacing="0">
                                <MudRadio Value="WebExperience.None" Color="Color.Secondary">No knowledge at all</MudRadio>
                                <MudRadio Value="WebExperience.LittleHtmlCssAndJs" Color="Color.Secondary">Know little Html, CSS and JS</MudRadio>
                                <MudRadio Value="WebExperience.DevelopedHobbyWebApp" Color="Color.Secondary">Developed small hobby app</MudRadio>
                                <MudRadio Value="WebExperience.DevelopedCommercialApp" Color="Color.Secondary">Developed Commercial app for users</MudRadio>
                            </MudStack>
                        </MudRadioGroup>
                    </MudItem>
                    <MudItem md="6" xs="12">
                        <MudText Typo="Typo.button">Database Development</MudText>
                        <MudRadioGroup @bind-Value="@model.DbExperience">
                            <MudStack Spacing="0">
                                <MudRadio Value="DbExperience.None" Color="Color.Secondary">No knowledge at all</MudRadio>
                                <MudRadio Value="DbExperience.KnowLittleSql" Color="Color.Secondary">Know little SQL and relational databases</MudRadio>
                                <MudRadio Value="DbExperience.ComfortableWithSql" Color="Color.Secondary">Comfortable with SQL and relational databases</MudRadio>
                                <MudRadio Value="DbExperience.DesignedDbForApp" Color="Color.Secondary">Desinged database (schemas, constraints etc.) for app</MudRadio>
                            </MudStack>
                        </MudRadioGroup>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <MudItem md="12">
            <MudButton ButtonType="ButtonType.Submit" Style="float:right"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Class="ml-auto"
                       StartIcon="@Icons.Material.Sharp.AddReaction">
                Apply for Traineeship
            </MudButton>
        </MudItem>
    </MudGrid>
</EditForm>

@code {

    private Student model = new();
    MudForm form;
    List<College> colleges = [];
    List<TechProgram> techPrograms = [];

    private async Task OnValidSubmit(EditContext editContext)
    {        
        // Save profile image first if it's uploaded
        // if(model.ProfileImage is not null)
        // {
        //     try
        //     {
        //         var fileName = Path.GetRandomFileName();
        //         var path = Path.Combine(Environment.ContentRootPath,
        //             Environment.EnvironmentName, "unsafe_uploads",
        //             trustedFileName);

        //         await using FileStream fs = new(path, FileMode.Create);
        //         await file.OpenReadStream(maxFileSize).CopyToAsync(fs);

        //         loadedFiles.Add(file);

        //         Logger.LogInformation(
        //             "Unsafe Filename: {UnsafeFilename} File saved: {Filename}",
        //             file.Name, trustedFileName);
        //     }
        //     catch (Exception ex)
        //     {
        //         Logger.LogError("File: {Filename} Error: {Error}",
        //             file.Name, ex.Message);
        //     }
        // }

        Db.Students.Add(model);
        var rowsAffected = await Db.SaveChangesAsync();

        if (rowsAffected > 0)
        {
            SnackBar.Add("Applicaion received successfully", Severity.Success);
        }
        else
        {
            SnackBar.Add("Applicaion process failed", Severity.Error);
        }
    }

    private async Task<IEnumerable<College>> SearchColleges(string value)
    {
        if (!colleges.Any())
        {
            colleges = Db.Colleges.ToList();
        }

        if (value is null or "")
        {
            return colleges;
        }

        return colleges.Where(x => x.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task<IEnumerable<TechProgram>> SearchPrograms(string value)
    {
        if (!techPrograms.Any())
        {
            techPrograms = Db.TechPrograms.ToList();
        }

        if (value is null or "")
        {
            return techPrograms;
        }

        return techPrograms.Where(x => x.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
    }
}
