@page "/budgeting"

@inject ApplicationDbContext Db

<PageTitle>Batch Budgeting</PageTitle>

@if (batchBudgets is null)
{
    <Loading />
}
else if(batchBudgets is [])
{
    <ApplicationAlert Type="Severity.Warning" Text="No budget plans found for any batch." />
}
else
{
    <MudGrid>
        <MudItem md="12">
            <MudFab Href="/budgeting/adjust"
                    Class="mt-2"
                    StartIcon="@Icons.Material.Filled.Add"
                    title="Adjust Batch Budgets"
                    Size="MudBlazor.Size.Small"
                    Color="MudBlazor.Color.Tertiary">
            </MudFab>
        </MudItem>
        @foreach (var batchBudget in batchBudgets ?? [])
        {
            <MudItem md="4">
                <MudPaper Elevation="5" Class="pa-5" Style="text-align:center">
                    <MudText Typo="Typo.h6" Class="mb-3">@batchBudget.Key</MudText>
                    <MudChart  ChartType="ChartType.Donut" Width="350px" Height="350px" LegendPosition="Position.Right"
                              InputData="@batchBudget.Value.Values"
                              InputLabels="@batchBudget.Value.Labels">
                        <CustomGraphics>
                            <text class="donut-inner-text" x="50%" y="35%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="25">Total</text>
                            <text class="donut-inner-text" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="50">@batchBudget.Value.Values.Sum().ToString()</text>
                        </CustomGraphics>
                    </MudChart>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>
}

@code {

    private record BatchBudgetRoot(string Batch, float? Revenue)
    {
        public IEnumerable<BatchBudget>? Budgets { get; set; }
    }

    private string _searchString = string.Empty;
    private KeyValuePair<string, (string[] Labels, double[] Values)>[] batchBudgets = null!;


    protected override async Task OnInitializedAsync()
    {
        var batchBudgetsDb = await Db.BatchBudgets
            .Include(x => x.Batch)
            .GroupBy(x => x.Batch.Name)
            .ToListAsync();

        batchBudgets = batchBudgetsDb.Select(x => new KeyValuePair<string, (string[], double[])>(x.Key, (x.Select(y => y.BudgetType.ToString()).ToArray(), x.Select(y => (double)y.Allocation).ToArray()))).ToArray();
    }
}
