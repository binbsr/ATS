@page "/gatherings/index"

@attribute [Authorize(Roles = Role.Admins)]
@inject ApplicationDbContext Db
@inject ISnackbar SnackBar

<PageTitle>All Events and Gatherings</PageTitle>

<MudDataGrid Items="@gatherings"
             Hover="true"
             Outlined
             Class="mt-2"
             Loading="@loadingData">
    <ToolBarContent>
        <MudFab Size="Size.Small" StartIcon="@Icons.Material.Outlined.Add" title="Add New Event" Href="/gatherings/create" Color="Color.Tertiary" />
        <MudSpacer />
        <MudChip Text="All Events" Label="true" Size="Size.Large" />
    </ToolBarContent>
    <Columns>
        <HierarchyColumn T="Training" ButtonDisabledFunc="@(x => (x.CourseQuote?.Modules?.Count ?? 0) == 0)" />
        <PropertyColumn Property="x => x.Title" />
        <PropertyColumn Property="x => x.Type" />
        <PropertyColumn Property="x => x.Quote" />
        <PropertyColumn Property="x => x.MaxAttendees" Title="Max" />
        <PropertyColumn Property="x => x.Created">
            <CellTemplate>
                @context.Item.Created.ToNepalTime().ToLongDateString()
            </CellTemplate>
        </PropertyColumn>

        <TemplateColumn>
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Warning" Href="@("/admin/quotes/edit/" + context.Item.Id)" />
                <MudIconButton Icon="@Icons.Material.Sharp.Delete" Size="Size.Small" Color="Color.Error" OnClick="() => ConfirmDelete(context.Item)" />
                <MudMessageBox @ref="mbox" Title="Warning" CancelText="Cancel">
                    <MessageContent>
                        Are you sure to delete this event? It can't be undone.
                    </MessageContent>
                    <YesButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Error" Class="ml-2 mb-2 mr-3" StartIcon="@Icons.Material.Filled.DeleteForever">Delete</MudButton>
                    </YesButton>
                </MudMessageBox>
            </CellTemplate>
        </TemplateColumn>
    </Columns>

    <ChildRowContent>
        <MudContainer Style="font-size: 1.3em">
            @((MarkupString)context.Item.Agenda.ToHtmlString())
        </MudContainer>
    </ChildRowContent>
    <PagerContent>
        <MudDataGridPager PageSizeOptions="[20, 50, 100, 200]" />
    </PagerContent>
</MudDataGrid>

@code {

    private List<Gathering> gatherings = [];

    private bool loadingData = false;
    private string searchString = string.Empty;
    private MudMessageBox mbox { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        loadingData = true;

        gatherings = await Db.Gatherings
            .OrderByDescending(x => x.Created)
            .ToListAsync();

        loadingData = false;
    }

    private async Task ConfirmDelete(Gathering gathering)
    {
        // bool? result = await mbox.ShowAsync();
        // if (result == null)
        //     return;

        // Db.Training.Remove(training);
        // var rowsAffected = await Db.SaveChangesAsync();

        // if (rowsAffected > 0)
        // {
        //     SnackBar.Add("Training plan deleted successfully", Severity.Success);
        //     trainings.Remove(training);
        // }
        // else
        // {
        //     SnackBar.Add("Training plan deletion failed", Severity.Error);
        // }
    }
}
