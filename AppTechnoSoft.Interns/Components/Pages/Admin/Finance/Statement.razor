@page "/financial-statement"

@inject ApplicationDbContext Db

<PageTitle>Financial Statement</PageTitle>

<MudDataGrid Items="@budgets"
             Loading="@loading"
             NoRecordsContent="noTransactions"
             Dense>
    <Columns>
        <PropertyColumn Property="x => x.Title" Title="Particulars" />
        <PropertyColumn Property="x => x.Date" Title="Date" Filterable="true" Groupable="true">            
            <CellTemplate>
                @context?.Item?.Date.Value.ToLongDateString()
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Credit" AggregateDefinition="CreditAggregation">
            <CellTemplate>
                @{
                    var value = context.Item.Credit;
                }
                @if (value is not null)
                {
                    <MudIcon Icon="@Icons.Material.Sharp.ArrowUpward" Color="Color.Success" Size="Size.Small" />
                    @value?.AsCurrency()
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Debit" AggregateDefinition="DebitAggregation">
            <CellTemplate>
                @{
                    var value = context.Item.Debit;
                }
                @if (value is not null)
                {
                    <MudIcon Icon="@Icons.Material.Sharp.ArrowDownward" Color="Color.Error" Size="Size.Small" />
                    @value?.AsCurrency()
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Balance" AggregateDefinition="BalanceAggregation">
            <CellTemplate>@context.Item.Balance?.AsCurrency()</CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Status">
            <CellTemplate>
                <MudChip Color="Color.Info" Size="Size.Small">@context.Item.Status</MudChip>
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Notes" />
    </Columns>
</MudDataGrid>

@code {

    private List<AccountViewModel> budgets = [];
    bool loading = true;
    private RenderFragment noTransactions = @<ApplicationAlert Type="Severity.Warning" Text="No transactions recorded yet." />;
    // private MudDataGrid<AccountViewModel> grid;

    protected override async Task OnInitializedAsync()
    {
        var currentYear = DateTime.Now.Year;
        var feeCollection = await Db.FinAccounts
            .Where(x => x.Enabled && x.Created.Value.Year == currentYear)
            .Select(y => new
            {
                StudentName = y.Student.Name,
                PaidTotal = y.PaidAmount,
                DateAdded = y.Created
            })
            .ToListAsync();

        // Fee credits
        if (feeCollection is not null)
        {
            foreach (var fee in feeCollection)
            {
                budgets.Add(new AccountViewModel
                {
                    Title = $"{fee.StudentName} - Tution Fee",
                    Credit = fee.PaidTotal,
                    Status = FundStatus.Paid,
                    Date = fee.DateAdded,
                    Notes = "Source: Fee Collection"
                });
            }
        }

        // Other revenue source credits
        var otherRevenues = await Db.Revenues.Where(x => x.Date.Value.Year == currentYear).ToArrayAsync();
        if (otherRevenues is not null)
        {
            foreach (var revenue in otherRevenues)
            {
                budgets.Add(new AccountViewModel
                {
                    Title = revenue.Particulars,
                    Credit = revenue.Amount,
                    Status = FundStatus.Paid,
                    Date = revenue.Date,
                    Notes = revenue.Source.ToString()
                });
            }
        }

        // Operations debits
        var expenses = await Db.Expenses.Where(x => x.Created.Value.Year == currentYear).ToListAsync();

        // Account debits
        if (expenses is not null)
        {
            foreach (var expense in expenses)
            {
                budgets.Add(new AccountViewModel
                {
                    Title = expense.Title,
                    Debit = expense.Amount,
                    Status = FundStatus.Paid,
                    Date = expense.Created,
                    Notes = expense.Description
                });
            }
        }

        budgets = budgets.OrderBy(x => x.Date).ToList();

        // Maintain balance at each step
        for (int counter = 0; counter < budgets.Count; counter++)
        {
            var accumulation = budgets.Take(counter + 1);
            budgets[counter].Balance = accumulation.Sum(x => x.Credit) - accumulation.Sum(x => x.Debit);
        }

        // Apply a default filter: Date == Current Year
        // var dateColumn = grid.GetColumnByPropertyName(nameof(AccountViewModel.Date));
        // if (dateColumn != null)
        // {
        //     grid.FilterDefinitions.Add(
        //         new FilterDefinition<AccountViewModel>
        //         {
        //             Column = dateColumn,
        //             Operator = FilterOperator.DateTime.OnOrAfter,
        //             Value = new DateTime(DateTime.Now.Year, 1, 1)
        //         }
        //     );
        // }

        loading = false;
    }

    AggregateDefinition<AccountViewModel> BalanceAggregation = new()
    {
        Type = AggregateType.Custom,
        CustomAggregate = x =>
        {
            var totalBalance = x.LastOrDefault()?.Balance;
            return $"{totalBalance?.AsCurrency()}";
        }
    };

    AggregateDefinition<AccountViewModel> CreditAggregation = new()
    {
        Type = AggregateType.Custom,
        CustomAggregate = x =>
        {
            var totalCredit = x.Sum(y => y.Credit);
            return $"{totalCredit?.AsCurrency()}";
        }
    };

    AggregateDefinition<AccountViewModel> DebitAggregation = new()
    {
        Type = AggregateType.Custom,
        CustomAggregate = x =>
        {
            var totalDebit = x.Sum(y => y.Debit);
            return $"{totalDebit?.AsCurrency()}";
        }
    };
}
