@page "/admin/websites/{Id}/manage"
@inject ApplicationDbContext Db

<PageTitle>@(site?.Name ?? "Site Details")</PageTitle>

@if (site is null)
{
    <Loading />
}
else
{
    <MudPaper Elevation="5" Class="d-flex align-center justify-center flex-grow-1 gap-4 p-3 mb-3">
        <MudText Typo="Typo.h5" Align="Align.Center">@site.Name</MudText>
        <MudLink Typo="Typo.h5" Href="@site.Domain" Color="Color.Info" Target="_blank">@site.Domain?.ToDomain()<MudIcon Icon="@Icons.Material.Sharp.OpenInNew" /></MudLink>
        <MudIconButton Color="Color.Warning" Href=@($"/admin/websites/edit/{site.Id}") Icon="@Icons.Material.Sharp.Edit" />
    </MudPaper>
    @if (site.Sections is null or [])
    {
        <ApplicationAlert Text=@($"No web site sections found for {site.Name}.") />
    }
    else
    {
        <MudExpansionPanels MultiExpansion="true" Outlined="true" Square="true">
            @foreach (var section in site.Sections)
            {
                <MudExpansionPanel Expanded="@true" Icon="@Icons.Material.Sharp.WebAsset" >
                    <TitleContent>
                        <MudText Inline="true" Typo="Typo.h6">@(section.Title)</MudText>
                        <MudIconButton Color="Color.Warning"
                                       Icon="@Icons.Material.Sharp.Edit"
                                       Href=@($"/admin/sitesection/edit/{section.Id}?SiteId={site.Id}") />
                    </TitleContent>
                    <ChildContent>
                        <MudGrid>
                            <MudItem xs="12">
                                <MudPaper Elevation="0" Outlined="true" Class="p-3">
                                    <pre>
                                                                @((MarkupString)(section.Content ?? ""))
                                                            </pre>
                                </MudPaper>
                            </MudItem>
                            @foreach (var widget in section.Widgets ?? [])
                            {
                                <MudItem xs="12" md="4" lg="3" xl="2">
                                    <MudPaper Elevation="0" Outlined="true" Class="p-2">
                                        <MudText Typo="Typo.h6" Class="mb-3" Inline="true">@widget.Description</MudText>
                                        <MudIconButton Color="Color.Warning"
                                                       Icon="@Icons.Material.Sharp.Edit"
                                                       Href=@($"/widgets/edit/{widget.Id}?Site={site.Id}&Section={section.Id}") />
                                        <pre>
                                                                            @((MarkupString)(widget.HtmlContent ?? ""))
                                                                        </pre>
                                    </MudPaper>
                                </MudItem>
                            }
                            <MudItem xs="6" md="4" lg="3" xl="2" Class="align-self-center">
                                <MudTooltip Text=@($"Add new {section.Title} item")>
                                    <MudIconButton Icon="@Icons.Material.Filled.DashboardCustomize"
                                                   Href=@($"/widgets/add?Site={site.Id}&Section={section.Id}")
                                                   Variant="Variant.Filled"
                                                   Size="Size.Large" />
                                </MudTooltip>
                            </MudItem>
                        </MudGrid>
                    </ChildContent>
                </MudExpansionPanel>
            }
        </MudExpansionPanels>

        <MudButton Variant="Variant.Filled"
                   Class="mt-3"
                   Size="Size.Large"
                   StartIcon="@Icons.Material.Sharp.PostAdd"
                   Href=@($"/admin/sitesection/new?SiteId={site.Id}")>Add Section</MudButton>
    }
}

@code {

    [Parameter]
    public string Id { get; set; }

    public Site site = null!;

    protected override async Task OnInitializedAsync()
    {
        if (Id == null)
            return;

        site = await Db.Sites.Where(x => x.Id == Id)
                            .Include(y => y.Sections)
                            .ThenInclude(z => z.Widgets)
                            .FirstOrDefaultAsync() ?? new();
    }

    // private async Task AddSiteItemAsync(int sectionId, Widget widget)
    // {
    //     var parameters = new DialogParameters<EditWidgetDialog> { { x => x.SectionId, sectionId }, { x => x.Model, widget } };
    //     var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large };
    //     var dialog = await DialogService.ShowAsync<EditWidgetDialog>((widget == null ? "Edit " : "Add ") + "Widget", parameters, options);
    //     var result = await dialog.Result;

    //     if ((int)(result?.Data ?? 0) != 0)
    //     {
    //         site = await Db.Sites.Where(x => x.Id == Id)
    //                         .Include(y => y.Sections)
    //                         .ThenInclude(z => z.Widgets)
    //                         .FirstOrDefaultAsync() ?? new();
    //     }
    // }
}
