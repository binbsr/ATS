@inject IDbContextFactory<ApplicationDbContext> DbFactory

<MudPaper Class="p-3 mb-2 border-solid border-2 mud-border-success" Elevation="5">
    @if (tags is null || tags.Count == 0)
    {
        <MudProgressCircular Size="Size.Large" />
    }
    else
    {
        if (ShowRootFilters)
        {
            <div class="border-b-2 border-solid mud-border-success mb-3 pb-3 d-flex justify-center">
                <MudText Typo="Typo.h6" Class="mt-3 mr-3">Select Learning Path</MudText>
                <MudChipSet SelectedChipChanged="RootFilterChanged" Filter Mandatory>
                    @foreach (var tag in roottags)
                    {
                        <MudChip Default="@(tag == RootFilter.All)" Variant="Variant.Outlined" Color="Color.Default" SelectedColor="Color.Success" Style="font-size:1.3rem;font-weight:500" Class="p-4" Text="@tag" />
                    }
                </MudChipSet>
            </div>
        }

        <MudChipSet Filter MultiSelection SelectedChipsChanged="FilterChanged">
             @foreach (var tag in tags)
            {
                <MudChip SelectedColor="Color.Success" Text="@tag.Name" Style="@("background:" + tag.ColorCode ?? "")" Class="text-white"></MudChip>
            }
        </MudChipSet>
    }
</MudPaper>

@code {

    [Parameter]
    public bool ShowRootFilters { get; set; } = true;

    [Parameter]
    public required string TagDescription { get; set; }

    [Parameter]
    public EventCallback<string> RootFilterTriggered { get; set; }

    [Parameter]
    public EventCallback<List<string>> FilterTriggered { get; set; }

    public List<Tag> tags = [];
    public List<string> roottags = [RootFilter.All, RootFilter.Internship, RootFilter.Professional, RootFilter.Corporate];

    protected override async Task OnInitializedAsync()
    {
        if (TagDescription is null or "")
            return;

        using var Db = DbFactory.CreateDbContext();
        tags = await Db.Tags.Where(x => x.Description!.Contains(TagDescription)).ToListAsync();
    }

    private async Task RootFilterChanged(MudChip chip)
    {
        await RootFilterTriggered.InvokeAsync(chip.Text);
    }

    private async Task FilterChanged(MudChip[] chips)
    {
        var filters = chips.Select(x => x.Text).ToList() ?? [];
        await FilterTriggered.InvokeAsync(filters);
    }
}
