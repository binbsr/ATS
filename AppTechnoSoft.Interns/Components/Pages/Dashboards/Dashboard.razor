@page "/dashboard"
@using AppTechnoSoft.Interns.Components.Account
@using Microsoft.AspNetCore.Identity

@attribute [Authorize]
@inject ApplicationDbContext Db

<PageTitle>Your dashboard</PageTitle>

@if (loadingData)
{
    <MudProgressCircular />
}
else
{
    <TraineeDash Student="@student" LoggedInUserId="@loggedInUserId" />
}


@code {

    bool loadingData = false;
    string loggedInUserId = string.Empty;
    Student? student;      

    [CascadingParameter]
    private Task<AuthenticationState> AuthTask { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        loadingData = true;
        var userTask = await AuthTask;
        var loggedInUser = userTask.User;
        loggedInUserId = loggedInUser?.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value ?? string.Empty;

        if (loggedInUserId == string.Empty)
            return;

        student = await Db.Students
            .Where(x => x.ApplicationUserId == loggedInUserId)
            .Include(b => b!.Batch)
            .Include(t => t.Team)
            .ThenInclude(b => b!.Project)
            .FirstOrDefaultAsync();
            
        loadingData = false;
    }
}
