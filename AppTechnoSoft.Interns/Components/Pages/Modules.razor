@page "/modules"

<PageTitle>Training Modules</PageTitle>

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar SnackBar

<TagFilter TagDescription="module" RootFilterTriggered="RootFilterChanged" FilterTriggered="FilterTagsChanged" />
@if (loadingData)
{
    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="mb-3" />
    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="mb-3" />
}
else
{
    <ModulesSection SectionTitle="Common Tech Patterns" Widgets="commonTechWidgets" />
    <ModulesSection SectionTitle="Language and SDKs" Widgets="sdkAndLangWidgets" />
    <ModulesSection SectionTitle="Database Access" Widgets="dataAccessWidgets" />
    <ModulesSection SectionTitle="Web Development" Widgets="webWidgets" />
    <ModulesSection SectionTitle="Security" Widgets="securityWidgets" />
    <ModulesSection SectionTitle="DevOps" Widgets="devOpsgWidgets" />
    <ModulesSection SectionTitle="Networking" Widgets="networkingWidgets" />
    <ModulesSection SectionTitle="Machine Learning" Widgets="mlWidgets" />
    <ModulesSection SectionTitle="Other Modules" Widgets="OtherWidgets" />
}

@code {

    List<Widget> widgets = [];
    List<Widget> widgetFiltered = [];
    IEnumerable<Widget> commonTechWidgets => widgetFiltered.Where(x => x.Tags!.Any(y => y.Name == ModuleSection.Common));
    IEnumerable<Widget> sdkAndLangWidgets => widgetFiltered.Where(x => x.Tags!.Any(y => y.Name == ModuleSection.Sdk));
    IEnumerable<Widget> dataAccessWidgets => widgetFiltered.Where(x => x.Tags!.Any(y => y.Name == ModuleSection.DataAccess));
    IEnumerable<Widget> webWidgets => widgetFiltered.Where(x => x.Tags!.Any(y => y.Name == ModuleSection.Web));
    IEnumerable<Widget> securityWidgets => widgetFiltered.Where(x => x.Tags!.Any(y => y.Name == ModuleSection.Security));
    IEnumerable<Widget> networkingWidgets => widgetFiltered.Where(x => x.Tags!.Any(y => y.Name == ModuleSection.Networking));
    IEnumerable<Widget> devOpsgWidgets => widgetFiltered.Where(x => x.Tags!.Any(y => y.Name == ModuleSection.Devops));
    IEnumerable<Widget> mlWidgets => widgetFiltered.Where(x => x.Tags!.Any(y => y.Name == ModuleSection.Ml));        
    IEnumerable<Widget> OtherWidgets => widgetFiltered
        .Except(commonTechWidgets)
        .Except(sdkAndLangWidgets)
        .Except(dataAccessWidgets)
        .Except(webWidgets)
        .Except(securityWidgets)
        .Except(networkingWidgets)
        .Except(devOpsgWidgets)
        .Except(mlWidgets);

    private List<Tag> tags = [];
    bool loadingData;

    protected override async Task OnInitializedAsync()
    {
        loadingData = true;

        using var Db = DbFactory.CreateDbContext();
        widgets = await Db.Widgets.Where(x => x.Title == "Module").Include(x => x.Tags).OrderBy(x => x.Description).ToListAsync();

        if (widgets is null || widgets.Count == 0)
            return;

        widgetFiltered = widgets;

        loadingData = false;
    }

    private void RootFilterChanged(string filterText)
    {
        widgetFiltered = widgets.Where(x => x.Tags!.Any(y => y.Name == filterText)).ToList();
    }

    private void FilterTagsChanged(string[] filterTexts)
    {
        if (filterTexts.Any())
        {
            widgetFiltered = widgets.Where(x => x.Tags!.Any(y => filterTexts.Contains(y.Name))).ToList();
        }
        else
        {
            widgetFiltered = widgets;
        }
    }

    private async Task DeleteInitiated(Widget widget)
    {
        using var Db = DbFactory.CreateDbContext();
        Db.Widgets.Remove(widget);

        var rowsAffected = await Db.SaveChangesAsync();

        if (rowsAffected > 0)
        {
            SnackBar.Add("Module Deleted successfully", Severity.Success);
            widgetFiltered.Remove(widget);
        }
        else
        {
            SnackBar.Add("Module Delete failed", Severity.Error);
        }
    }
}
