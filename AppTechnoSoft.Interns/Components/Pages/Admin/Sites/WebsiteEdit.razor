@page "/admin/websites/new"
@page "/admin/websites/edit/{Id}"

@attribute [Authorize(Roles = Role.Admins)]

@inject ApplicationDbContext Db
@inject ISnackbar SnackBar

<PageTitle>@pageTitle</PageTitle>

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <MudTextField Label="Name" @bind-Value="model.Name" Variant="Variant.Outlined" />
    <MudTextField Label="Domain" Class="mt-3" @bind-Value="model.Domain" Variant="Variant.Outlined" />
    <MudTextField Label="Customer" Class="mt-3" @bind-Value="model.Client" Variant="Variant.Outlined" />
    <MudSelect Label="Clone site content from"
               @bind-Value="selectedSourceSiteId"
               Variant="Variant.Outlined">
        <MudSelectItem Value=@("")>No Cloning</MudSelectItem>
        @foreach (var site in sites)
        {
            <MudSelectItem Value="@site.Id">@site.Name (@site.Domain)</MudSelectItem>
        }
    </MudSelect>

    <MudTextField Class="mt-2" Lines="10" @bind-Value="@model.Content" Variant="Variant.Outlined" Label="Site Root HTML" AutoGrow />

    <MudButton ButtonType="ButtonType.Submit"
               Variant="Variant.Filled"
               Disabled="@saving"
               Color="Color.Primary"
               Class="mt-3"
               StartIcon="@Icons.Material.Filled.Save">
        Save @model.Name Site
    </MudButton>
</EditForm>

@code {

    [Parameter]
    public string? Id { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState> AuthTask { get; set; } = null!;

    private Site model = new();
    private IEnumerable<Section> siteSections = [];
    private string pageTitle = string.Empty;
    private bool IsAdd => Id is null or "";
    private IReadOnlyCollection<Section> selectedSections = [];
    private IEnumerable<Site> sites = [];
    private string selectedSourceSiteId = string.Empty;
    private bool saving = false;

    protected override async Task OnInitializedAsync()
    {
        sites = await Db.Sites.ToListAsync();

        if (IsAdd)
        {
            pageTitle = "New Website";
        }
        else
        {
            pageTitle = "Edit Website";
            model = await Db.Sites.Where(x => x.Id == Id).Include(y => y.Sections).FirstOrDefaultAsync() ?? new();
            selectedSections = model?.Sections ?? [];
        }

        siteSections = await Db.Sections.ToListAsync();
    }

    private async Task OnValidSubmit(EditContext context)
    {
        saving = true;
        var state = await AuthTask;
        var userName = state.User.Identity?.Name;

        if (IsAdd)
        {
            model.AddCreatedStamps(userName);
            Db.Sites.Add(model);
        }
        else
        {
            model.Id = Id;
            model.AddLastUpdatedStamps(userName);
            model.Sections = selectedSections.ToList();
            Db.Sites.Update(model);
        }

        // Cloning Logic
        if (!string.IsNullOrEmpty(selectedSourceSiteId))
        {
            var sourceSections = await Db.Sections
                .Where(s => s.SiteId == selectedSourceSiteId)
                .Include(s => s.SectionItems)
                .ToListAsync();

            if (sourceSections != null && sourceSections.Count != 0)
            {
                model.Sections = [];
                foreach (var section in sourceSections)
                {
                    var newSection = new Section
                    {
                        Title = section.Title,
                        Content = section.Content,
                        SiteId = model.Id
                    };

                    newSection.SectionItems = [];

                    foreach (var widget in section?.SectionItems ?? [])
                    {
                        var newWidget = new SectionItem
                        {
                            Title = widget.Title,
                            Content = widget.Content
                        };
                        newWidget.AddCreatedStamps(userName);
                        newSection.SectionItems.Add(newWidget);
                    }

                    model.Sections.Add(newSection);
                }
            }
        }

        var rowsAffected = await Db.SaveChangesAsync();

        saving = false;

        if (rowsAffected > 0)
        {
            SnackBar.Add("Site saved successfully", Severity.Success);
        }
        else
        {
            SnackBar.Add("Site save failed", Severity.Error);
        }
    }
}
