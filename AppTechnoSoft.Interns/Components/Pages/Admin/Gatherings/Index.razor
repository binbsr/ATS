@page "/gatherings"

@attribute [Authorize(Roles = Role.Admins)]
@inject ApplicationDbContext Db
@inject ISnackbar SnackBar
@inject IDialogService DialogService

<PageTitle>All Events and Gatherings</PageTitle>

@if (loadingData)
{
    <Loading />
}
else
{
    <MudGrid>
        @foreach (var gathering in gatherings)
        {
            <MudItem xl="3" lg="4" md="4" sm="6" xs="12">
                <MudCard Elevation="5">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudIcon Size="Size.Large" Color="Color.Secondary" Icon="@Icons.Material.Sharp.Event" />
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.body1">@gathering.Type</MudText>
                            <MudText Typo="Typo.body2">@gathering.Title</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudButton Variant="Variant.Filled"
                                       Size="Size.Small"
                                       @onclick="() => OpenDialogAsync(gathering)"
                                       StartIcon="@Icons.Material.Filled.ScheduleSend"
                                       Disabled="@(requestedEvent == gathering.Id)"
                                       Color="Color.Secondary">
                                Request
                            </MudButton>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body2">@((MarkupString)gathering.Agenda.ToHtmlString())</MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Favorite" Color="Color.Error" />
                        <MudIconButton Icon="@Icons.Material.Filled.Share" Color="Color.Info" />
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}

@code {

    private List<Gathering> gatherings = [];

    private bool loadingData = false;
    private string searchString = string.Empty;
    private MudMessageBox mbox { get; set; } = null!;
    Guid requestedEvent = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        loadingData = true;

        gatherings = await Db.Gatherings
            .OrderByDescending(x => x.Created)
            .ToListAsync();

        loadingData = false;
    }

    private async Task OpenDialogAsync(Gathering gathering)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium, };
        var parameters = new DialogParameters<RequestDialog> { { x => x.Gathering, gathering } };
        var dialogReturned = await DialogService.ShowAsync<RequestDialog>($"Request for the {gathering.Type}", parameters, options);
        var result = await dialogReturned.Result;
        requestedEvent = (Guid)(result?.Data ?? Guid.Empty);

        if (result != null && !result.Canceled && requestedEvent != Guid.Empty)
        {
            SnackBar.Add($"We received your request successfully for {gathering.Type} : '{gathering.Title}'", Severity.Success);
        }
    }

    private async Task ConfirmDelete(Gathering gathering)
    {
        // bool? result = await mbox.ShowAsync();
        // if (result == null)
        //     return;

        // Db.Training.Remove(training);
        // var rowsAffected = await Db.SaveChangesAsync();

        // if (rowsAffected > 0)
        // {
        //     SnackBar.Add("Training plan deleted successfully", Severity.Success);
        //     trainings.Remove(training);
        // }
        // else
        // {
        //     SnackBar.Add("Training plan deletion failed", Severity.Error);
        // }
    }
}
