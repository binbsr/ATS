@page "/admin/websites/{Id}/manage"

@inject ApplicationDbContext Db
@inject ISnackbar SnackBar
@inject IDialogService DialogService

<PageTitle>@($"{site?.Name ?? "Site Details"} Management")</PageTitle>

@if (site is null)
{
    <Loading />
}
else if (siteNotFound)
{
    <ApplicationAlert Text="Site with provided Id don't exist the system" />
}
else
{
    <MudPaper Class="py-4 px-3 mb-3 gap-2 d-flex align-center" Elevation="5" Square>
        <MudIconButton Color="Color.Warning" Href=@($"/admin/websites/edit/{site.Id}") Icon="@Icons.Material.Sharp.Edit" />
        <MudText Typo="Typo.h5">@site.Name</MudText>
        <MudLink Typo="Typo.h6" Href="@site.Domain" Color="Color.Info" Target="_blank">@site.Domain?.ToDomain()<MudIcon Icon="@Icons.Material.Sharp.OpenInNew" /></MudLink>
        <MudText Typo="Typo.h5">@site.Sections?.Count Sections, @(site.Sections?.Sum(x => x.SectionItems?.Count ?? 0)) Widgets</MudText>

        <MudSpacer />
        <MudButton StartIcon="@Icons.Material.Sharp.Save"
                   Color="Color.Warning"
                   Disabled="@(!_orderSectionChanged)"
                   OnClick="async () => await SaveSectionOrderAsync()">Save Section Order</MudButton>
        <MudButton StartIcon="@Icons.Material.Sharp.Refresh"
                   Color="Color.Default"
                   Disabled="@(!_orderSectionChanged)"
                   OnClick="async () => await ResetSectionOrderAsync()">Reset Sections</MudButton>

    </MudPaper>

    @if (sections is null or [])
    {
        <ApplicationAlert Text=@($"No web site sections found for {site.Name}.") />
    }
    else
    {
        @foreach (var section in sections)
        {
            <MudPaper Class="mb-3 pa-3 border-dotted border-3" Elevation="0" Outlined="true">
                <div class="d-flex align-center">
                    <MudIconButton Icon="@(IsSectionExpanded(section.Id) ? Icons.Material.Sharp.HorizontalRule : Icons.Material.Sharp.Add)"
                                   OnClick="() => ToggleSection(section.Id)" />

                    @if (section.Enabled)
                    {
                        <MudIcon Icon="@Icons.Material.Sharp.Public" Color="Color.Success" Title="Published to Site" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Sharp.PublicOff" Color="Color.Warning" Title="Saved as Draft" />
                    }

                    <MudText Typo="Typo.h6" Class="ml-2">@(section.Title)</MudText>
                    <MudSpacer />
                    <MudIconButton Color="Color.Default" Icon="@Icons.Material.Sharp.KeyboardArrowUp"
                                   Size="Size.Large"
                                   Disabled="@(sections.IndexOf(section) == 0)"
                                   OnClick="async () => await MoveSectionUpAsync(section)" />
                    <MudIconButton Color="Color.Default" Icon="@Icons.Material.Sharp.KeyboardArrowDown"
                                   Size="Size.Large"
                                   Disabled="@(sections.IndexOf(section) == sections.Count - 1)" OnClick="async () => await MoveSectionDownAsync(section)" />

                </div>


                <MudCollapse Expanded="@IsSectionExpanded(section.Id)">
                    <MudGrid>
                        <MudItem xs="12" lg="9">
                            <MudPaper Elevation="0" Outlined="true">
                                <MudTabs>
                                    <MudTabPanel Text="Code" Icon="@Icons.Material.Sharp.Code">
                                        @if (IsEditing(section.Id))
                                        {
                                            <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small" Class="d-flex justify-end gap-2">
                                                <MudButton StartIcon="@Icons.Material.Sharp.Cancel"
                                                           IconColor="Color.Error"
                                                           OnClick="() => ToggleEditing(section.Id)">Cancel</MudButton>

                                                <MudButton StartIcon="@Icons.Material.Sharp.Save"
                                                           IconColor="Color.Success"
                                                           OnClick="() => SaveInlineSection(section)">Save</MudButton>
                                            </MudButtonGroup>

                                            <MudTextField T="string" Label="@(section.Title)"
                                                          Variant="Variant.Outlined"
                                                          Class=""
                                                          @bind-Value="section.Content"
                                                          Lines="6"
                                                          AutoGrow
                                                          AutoFocus />
                                        }
                                        else
                                        {
                                            <MudFab Color="Color.Warning"
                                                    Class="mr-2"
                                                    Style="float:right"
                                                    OnClick="() => ToggleEditing(section.Id)"
                                                    StartIcon="@Icons.Material.Filled.EditNote"
                                                    Size="Size.Small" />
                                            <pre>@(section.Content)</pre>
                                        }
                                    </MudTabPanel>
                                    <MudTabPanel Text="Preview" Icon="@Icons.Material.Sharp.Preview">
                                        @((MarkupString)(section.Content ?? ""))
                                    </MudTabPanel>
                                </MudTabs>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" lg="3">
                            <MudStack>
                                <MudButton Color="Color.Warning"
                                           Variant="Variant.Outlined"
                                           StartIcon="@Icons.Material.Sharp.Edit"
                                           Href=@($"/admin/sitesection/edit/{section.Id}?SiteId={site.Id}")>
                                    Edit Section Details
                                </MudButton>

                                <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           Disabled="@(!_orderWidgetChanged)"
                                           OnClick="async () => await PersistSectionItemsOrderAsync(section)">
                                    Save Section Items Order
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Default"
                                           StartIcon="@Icons.Material.Filled.Refresh"
                                           Disabled="@(!_orderWidgetChanged)"
                                           OnClick="async () => await ResetSectionItemsOrderAsync(section)">
                                    Reset Section Items
                                </MudButton>

                            </MudStack>

                        </MudItem>
                        @foreach (var widget in section.SectionItems ?? [])
                        {
                            <MudItem xs="12" md="4" lg="3" xl="2">
                                <MudPaper Elevation="0" Outlined="true" Class="py-1">
                                    <div class="d-flex align-center">
                                        <MudIconButton Color="Color.Warning"
                                                       OnClick="() => EditSiteItemAsync(section, widget)"
                                                       Icon="@Icons.Material.Sharp.Edit" />
                                        <MudText Typo="Typo.h6" Inline="true">@widget.Title</MudText>

                                        <MudSpacer />
                                        <MudIconButton Color="Color.Default" Icon="@Icons.Material.Sharp.KeyboardArrowLeft"
                                                       Disabled="@(section.SectionItems?.IndexOf(widget) == 0)"
                                                       OnClick="async () => await MoveWidgetLeftAsync(section, widget)" />
                                        <MudIconButton Color="Color.Default" Icon="@Icons.Material.Sharp.KeyboardArrowRight"
                                                       Disabled="@(section.SectionItems is null || section.SectionItems.IndexOf(widget) == section.SectionItems.Count - 1)"
                                                       OnClick="async () => await MoveWidgetRightAsync(section, widget)" />
                                    </div>
                                    <MudTabs Outlined>
                                        <MudTabPanel Text="Code" Icon="@Icons.Material.Sharp.Code">
                                            @if (IsEditing(widget.Id))
                                            {
                                                <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small" Class="d-flex justify-end gap-2">
                                                    <MudButton StartIcon="@Icons.Material.Sharp.Cancel"
                                                               IconColor="Color.Error"
                                                               OnClick="() => ToggleEditing(widget.Id)">Cancel</MudButton>

                                                    <MudButton StartIcon="@Icons.Material.Sharp.Save"
                                                               IconColor="Color.Success"
                                                               OnClick="() => SaveInlineWidget(widget)">Save</MudButton>
                                                </MudButtonGroup>
                                                <MudTextField T="string" Label="@(widget.Title)"
                                                              Variant="Variant.Outlined"
                                                              Class=""
                                                              @bind-Value="widget.Content"
                                                              Lines="6"
                                                              AutoGrow
                                                              AutoFocus />
                                            }
                                            else
                                            {
                                                <MudFab Color="Color.Warning"
                                                        Class="mr-2"
                                                        Style="float:right"
                                                        OnClick="() => ToggleEditing(widget.Id)"
                                                        StartIcon="@Icons.Material.Filled.EditNote"
                                                        Size="Size.Small" />
                                                <pre>@(widget.Content)</pre>
                                            }

                                        </MudTabPanel>
                                        <MudTabPanel Text="Preview" Icon="@Icons.Material.Sharp.Preview">
                                            @((MarkupString)(widget.Content ?? ""))
                                        </MudTabPanel>
                                    </MudTabs>

                                </MudPaper>
                            </MudItem>
                        }
                        <MudItem xs="12" md="4" lg="3" xl="2" Class="align-self-center">
                            <MudTooltip Text=@($"Add new {section.Title} item")>
                                <MudIconButton Icon="@Icons.Material.Filled.DashboardCustomize"
                                               OnClick="() => EditSiteItemAsync(section)"
                                               Variant="Variant.Filled"
                                               Size="Size.Large" />
                            </MudTooltip>
                        </MudItem>
                    </MudGrid>
                </MudCollapse>
            </MudPaper>
        }

        <MudButton Variant="Variant.Filled"
                   Size="Size.Large"
                   StartIcon="@Icons.Material.Sharp.PostAdd"
                   Href=@($"/admin/sitesection/new?SiteId={site.Id}")>Add Section</MudButton>
    }
}

@code {

    [Parameter]
    public required string Id { get; set; }

    private Site? site = null!;
    private List<Section> sections = [];

    private HashSet<int> _expandedSections = [];
    private HashSet<int> _editingItems = [];

    private bool _orderSectionChanged = false;
    private bool _orderWidgetChanged = false;
    private bool siteNotFound = false;

    protected override async Task OnInitializedAsync()
    {
        if (Id == null)
            return;

        site = await Db.Sites.FirstOrDefaultAsync(x => x.Id == Id);
        if (site == null)
        {
            siteNotFound = true;
            return;
        }
        else
        {
            siteNotFound = false;
        }

        sections = await Db.Sections
                            .Where(x => x.SiteId == Id)
                            .Include(y => y.SectionItems.OrderBy(w => w.Order))
                            .OrderBy(s => s.Order)
                            .ToListAsync() ?? [];
    }

    private bool IsSectionExpanded(int id) => _expandedSections.Contains(id);
    private bool IsEditing(int id) => _editingItems.Contains(id);

    private void ToggleSection(int id)
    {
        if (_expandedSections.Contains(id))
            _expandedSections.Remove(id);
        else
            _expandedSections.Add(id);
    }

    private void ToggleEditing(int id)
    {
        if (_editingItems.Contains(id))
            _editingItems.Remove(id);
        else
            _editingItems.Add(id);
    }

    private async Task MoveSectionUpAsync(Section section)
    {
        var index = sections.IndexOf(section);
        if (index <= 0) return;

        // swap in list
        sections.RemoveAt(index);
        sections.Insert(index - 1, section);

        _orderSectionChanged = true;
    }

    private async Task MoveSectionDownAsync(Section section)
    {
        var index = sections.IndexOf(section);
        if (index < 0 || index >= sections.Count - 1) return;

        // swap in list
        sections.RemoveAt(index);
        sections.Insert(index + 1, section);

        _orderSectionChanged = true;
    }

    // Persist the Order property to the database for all sections (transactional)
    private async Task SaveSectionOrderAsync()
    {
        if (!_orderSectionChanged)
            return;

        // update in-memory Order to match current list positions
        for (int i = 0; i < sections.Count; i++)
        {
            sections[i].Order = i;
        }

        try
        {
            foreach (var s in sections)
            {
                await Db.Sections
                    .Where(x => x.Id == s.Id)
                    .ExecuteUpdateAsync(u => u.SetProperty(b => b.Order, s.Order));
            }

            _orderSectionChanged = false;
            SnackBar.Add("Section order saved.", Severity.Success);
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Failed to save section order: {ex.Message}", Severity.Error);
        }
    }

    private Task ResetSectionOrderAsync()
    {
        // reload original order from DB
        _ = InvokeAsync(async () =>
        {
            sections = await Db.Sections
                                .Where(x => x.SiteId == Id)
                                .OrderBy(s => s.Order)
                                .ToListAsync();

            _orderSectionChanged = false;
            StateHasChanged();
        });

        return Task.CompletedTask;
    }

    private async Task MoveWidgetLeftAsync(Section section, SectionItem widget)
    {
        if (section.SectionItems is null) return;
        var index = section.SectionItems.IndexOf(widget);
        if (index <= 0) return;

        section.SectionItems.RemoveAt(index);
        section.SectionItems.Insert(index - 1, widget);

        _orderWidgetChanged = true;
    }

    private async Task MoveWidgetRightAsync(Section section, SectionItem widget)
    {
        if (section.SectionItems is null) return;
        var index = section.SectionItems.IndexOf(widget);
        if (index < 0 || index >= section.SectionItems.Count - 1) return;

        section.SectionItems.RemoveAt(index);
        section.SectionItems.Insert(index + 1, widget);

        _orderWidgetChanged = true;
    }

    private async Task PersistSectionItemsOrderAsync(Section section)
    {
        if (section.SectionItems is null) return;

        for (int i = 0; i < section.SectionItems.Count; i++)
        {
            section.SectionItems[i].Order = i;
        }

        try
        {
            foreach (var it in section.SectionItems)
            {
                await Db.SectionItems
                    .Where(x => x.Id == it.Id)
                    .ExecuteUpdateAsync(u => u.SetProperty(b => b.Order, it.Order));
            }

            SnackBar.Add("Section widgets order saved.", Severity.Success);
            _orderWidgetChanged = false;
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Failed to save widget order: {ex.Message}", Severity.Error);
        }
    }

    private Task ResetSectionItemsOrderAsync(Section section)
    {
        // reload original order from DB
        _ = InvokeAsync(async () =>
        {
            section.SectionItems = await Db.SectionItems
                                .Where(x => x.SectionId == section.Id)
                                .OrderBy(s => s.Order)
                                .ToListAsync();

            _orderWidgetChanged = false;
            StateHasChanged();
        });

        return Task.CompletedTask;
    }

    private async Task SaveInlineSection(Section section)
    {
        var rowsUpdated = await Db.Sections
        .Where(s => s.Id == section.Id)
        .ExecuteUpdateAsync(setters => setters.SetProperty(b => b.Content, section.Content));

        if (rowsUpdated > 0)
        {
            SnackBar.Add("Section saved successfully.", Severity.Success);
            ToggleEditing(section.Id);
        }
    }

    private async Task SaveInlineWidget(SectionItem widget)
    {
        var rowsUpdated = await Db.Widgets
        .Where(s => s.Id == widget.Id)
        .ExecuteUpdateAsync(setters => setters.SetProperty(b => b.HtmlContent, widget.Content));

        if (rowsUpdated > 0)
        {
            SnackBar.Add("Widget saved successfully.", Severity.Success);
            ToggleEditing(widget.Id);
        }
    }

    private async Task EditSiteItemAsync(Section section, SectionItem? item = null)
    {
        bool isAdd = item == null;
        var parameters = new DialogParameters<EditSiteWidgetDialog> { { x => x.SectionId, section.Id }, { x => x.SectionItem, item } };
        var options = new DialogOptions { CloseButton = true, FullWidth = true };
        var dialog = await DialogService.ShowAsync<EditSiteWidgetDialog>((isAdd ? "Add " : "Edit ") + "Widget", parameters, options);
        var result = await dialog.Result;
        var returnModel = result?.Data as SectionItem;

        if (returnModel == null)
            return;

        if (isAdd)
        {
            if (section.SectionItems is null)
                section.SectionItems = [];

            section.SectionItems.Add(returnModel);


            SnackBar.Add("Widget added successfully.", Severity.Success);
        }
        else
        {
            var widgetIndex = section.SectionItems!.FindIndex(w => w.Id == returnModel.Id);
            if (widgetIndex != -1)
            {
                section.SectionItems[widgetIndex] = returnModel;
                SnackBar.Add("Widget updated successfully.", Severity.Success);
            }
        }
    }
}
